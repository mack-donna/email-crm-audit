name: Claude Code Security Review

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.py'
      - '**.js'
      - '**.ts'
      - '**.tsx'
      - '**.html'
  workflow_dispatch:
    inputs:
      review_scope:
        description: 'Review scope (changed_files or all_files)'
        required: false
        default: 'changed_files'
        type: choice
        options:
          - changed_files
          - all_files

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write

jobs:
  security-review:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better context

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Claude Code CLI
      run: |
        # Install Claude Code CLI (using npm)
        npm install -g @anthropic-ai/claude-code

        # Verify installation
        claude --version || echo "Claude Code CLI installed"

    - name: Get changed files
      id: changed-files
      if: github.event_name == 'pull_request'
      uses: tj-actions/changed-files@v42
      with:
        files: |
          **.py
          **.js
          **.ts
          **.tsx
          **.html

    - name: Create security review prompt
      run: |
        cat > .claude-security-review.md << 'EOF'
        # Security Review Instructions

        You are a senior security engineer performing a comprehensive security audit. Analyze the provided code for security vulnerabilities with a focus on:

        ## OWASP Top 10 Vulnerabilities
        1. **SQL Injection** - Check for unsanitized database queries
        2. **Cross-Site Scripting (XSS)** - Check for unescaped user input in HTML/JS
        3. **Broken Authentication** - Review auth flows and session management
        4. **Sensitive Data Exposure** - Check for exposed API keys, passwords, tokens
        5. **XML External Entities (XXE)** - Review XML parsing
        6. **Broken Access Control** - Check authorization logic
        7. **Security Misconfiguration** - Review security settings
        8. **Insecure Deserialization** - Check pickle, yaml, json usage
        9. **Using Components with Known Vulnerabilities** - Review dependencies
        10. **Insufficient Logging & Monitoring** - Check security event logging

        ## Python-Specific Security Issues
        - Command injection via os.system(), subprocess, eval()
        - Path traversal vulnerabilities in file operations
        - Pickle deserialization attacks
        - Insecure random number generation (random vs secrets)
        - Timing attacks in authentication
        - SSRF in HTTP requests
        - Insecure SSL/TLS configuration
        - Regex denial of service (ReDoS)

        ## API & Integration Security
        - Hardcoded API keys or credentials
        - Insecure API authentication
        - Missing rate limiting
        - Insufficient input validation
        - Exposed debug endpoints
        - CORS misconfigurations

        ## Output Format
        For each vulnerability found, provide:

        ### ðŸ”´ CRITICAL | ðŸŸ¡ MEDIUM | ðŸŸ¢ LOW
        **File**: `path/to/file.py:line_number`
        **Issue**: Brief description
        **Risk**: Explanation of potential impact
        **Code**:
        \`\`\`python
        # Show the vulnerable code
        \`\`\`
        **Fix**:
        \`\`\`python
        # Show the secure alternative
        \`\`\`

        ## Summary
        - Total Issues: X
        - Critical: X
        - Medium: X
        - Low: X

        If no issues found, respond with: "âœ… No security vulnerabilities detected."
        EOF

    - name: Run security review with Claude Code
      id: security-scan
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        # Prepare files for review
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          FILES="${{ steps.changed-files.outputs.all_changed_files }}"
        else
          FILES=$(find . -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" \) -not -path "*/\.*" -not -path "*/node_modules/*" -not -path "*/venv/*")
        fi

        # Create results directory
        mkdir -p security-reports

        # Run Claude Code security review
        echo "# Claude Code Security Review Results" > security-reports/review.md
        echo "" >> security-reports/review.md
        echo "**Reviewed at**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> security-reports/review.md
        echo "**Trigger**: ${{ github.event_name }}" >> security-reports/review.md
        echo "" >> security-reports/review.md

        if [ -z "$FILES" ]; then
          echo "No files to review" >> security-reports/review.md
        else
          echo "## Files Reviewed" >> security-reports/review.md
          echo '```' >> security-reports/review.md
          echo "$FILES" >> security-reports/review.md
          echo '```' >> security-reports/review.md
          echo "" >> security-reports/review.md

          # Run Claude Code analysis
          # Note: Adjust this command based on actual Claude Code CLI syntax
          echo "Running security analysis..."

          for file in $FILES; do
            if [ -f "$file" ]; then
              echo "Analyzing: $file"

              # Run Claude Code with security review prompt
              claude code review \
                --file "$file" \
                --prompt-file .claude-security-review.md \
                --output security-reports/$(basename $file).md \
                2>&1 || echo "Analysis completed for $file"
            fi
          done

          # Combine all reports
          echo "## Security Analysis" >> security-reports/review.md
          cat security-reports/*.md >> security-reports/review.md 2>/dev/null || echo "No detailed reports generated"
        fi

        # Set output for next steps
        echo "report_path=security-reports/review.md" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Run Python security linters
      run: |
        # Install security linting tools
        pip install bandit safety

        echo "## Python Security Scan (Bandit)" >> security-reports/review.md
        echo '```' >> security-reports/review.md
        bandit -r . -f txt -o security-reports/bandit.txt -x ./venv,./node_modules || true
        cat security-reports/bandit.txt >> security-reports/review.md 2>/dev/null || echo "No Bandit results"
        echo '```' >> security-reports/review.md

        echo "## Dependency Vulnerabilities (Safety)" >> security-reports/review.md
        echo '```' >> security-reports/review.md
        safety check --json > security-reports/safety.json 2>&1 || true
        cat security-reports/safety.json >> security-reports/review.md 2>/dev/null || echo "No Safety results"
        echo '```' >> security-reports/review.md
      continue-on-error: true

    - name: Manual security checks
      run: |
        echo "" >> security-reports/review.md
        echo "## Manual Security Checks" >> security-reports/review.md
        echo "" >> security-reports/review.md

        # Check for hardcoded secrets patterns
        echo "### Hardcoded Secrets Scan" >> security-reports/review.md
        echo '```' >> security-reports/review.md

        # Look for common secret patterns
        grep -rn --include="*.py" --include="*.js" --include="*.env" \
          -e "password\s*=\s*['\"][^'\"]\+['\"]" \
          -e "api_key\s*=\s*['\"][^'\"]\+['\"]" \
          -e "secret\s*=\s*['\"][^'\"]\+['\"]" \
          -e "token\s*=\s*['\"][^'\"]\+['\"]" \
          -e "AWS_ACCESS_KEY" \
          -e "ANTHROPIC_API_KEY\s*=\s*['\"]" \
          . 2>/dev/null || echo "âœ… No obvious hardcoded secrets found"

        echo '```' >> security-reports/review.md
        echo "" >> security-reports/review.md

        # Check for dangerous functions
        echo "### Dangerous Function Usage" >> security-reports/review.md
        echo '```' >> security-reports/review.md

        grep -rn --include="*.py" \
          -e "eval(" \
          -e "exec(" \
          -e "os.system(" \
          -e "__import__" \
          -e "pickle.loads(" \
          . 2>/dev/null || echo "âœ… No dangerous functions found"

        echo '```' >> security-reports/review.md
      continue-on-error: true

    - name: Generate security summary
      run: |
        echo "" >> security-reports/review.md
        echo "---" >> security-reports/review.md
        echo "" >> security-reports/review.md
        echo "## Review Complete" >> security-reports/review.md
        echo "" >> security-reports/review.md
        echo "This automated security review was performed by Claude Code." >> security-reports/review.md
        echo "For questions or to report false positives, please contact the security team." >> security-reports/review.md

    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-review-report
        path: security-reports/
        retention-days: 90

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const reportPath = 'security-reports/review.md';

          if (fs.existsSync(reportPath)) {
            const report = fs.readFileSync(reportPath, 'utf8');

            // Truncate if too long for PR comment
            const maxLength = 65000;
            let comment = report;

            if (comment.length > maxLength) {
              comment = comment.substring(0, maxLength) + '\n\n... (truncated, see full report in artifacts)';
            }

            // Post comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

    - name: Add to job summary
      if: always()
      run: |
        cat security-reports/review.md >> $GITHUB_STEP_SUMMARY

    - name: Check for critical vulnerabilities
      run: |
        # Fail the build if critical issues are found
        if grep -q "ðŸ”´ CRITICAL" security-reports/review.md; then
          echo "::error::Critical security vulnerabilities detected! Review the security report."
          exit 1
        fi
      continue-on-error: true
